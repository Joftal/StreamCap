# StreamCap 内存优化测试指南

本指南将帮助您验证内存管理优化的效果，确保系统在长时间运行时稳定且资源使用合理。

## 测试准备

1. 确保已安装所有依赖：
   ```bash
   pip install -r requirements.txt
   ```

2. 确保已安装 `psutil` 模块：
   ```bash
   pip install psutil
   ```

## 测试方法

我们提供了三种测试方法，从简单到复杂：

### 1. 内存管理测试

这个测试会创建多个平台处理器实例并监控它们的内存使用情况，测试实例自动清理机制是否有效。

```bash
python run_memory_test.py --type memory
```

### 2. 应用关闭测试

这个测试会模拟应用关闭过程，验证资源是否能够被正确释放。

```bash
python run_memory_test.py --type close
```

### 3. 完整应用测试

这个测试需要您手动启动应用并进行操作，用于验证实际使用场景下的内存管理效果。

```bash
python run_memory_test.py --type full --duration 300
```

执行此命令后，请手动启动应用（`python main.py`），然后进行以下操作：
1. 添加5-10个直播间进行监控
2. 让应用运行一段时间（建议至少5分钟）
3. 观察内存使用情况
4. 完成测试后回到测试脚本窗口按 Ctrl+C 结束测试

## 如何查看日志

所有测试日志都保存在 `logs` 目录下，测试脚本会自动分析最新的日志文件。您也可以手动查看日志文件了解更多细节。

## 判断优化是否有效

请检查以下几点来判断内存优化是否有效：

### 1. 内存使用情况

- **内存稳定性**：内存使用量应该在一定范围内波动，而不是持续增长。
- **内存增长率**：随着时间推移，内存增长率应该降低或保持在很低的水平。
- **清理效果**：清理操作后内存使用应该有明显下降。

### 2. 实例管理

- **实例清理**：长时间未使用的平台处理器实例应该被自动清理。
- **实例数量**：实例数量应该随着时间的推移而减少，不应持续增加。

### 3. 进程管理

- **进程终止**：进程应该能够被正确终止，不会留下僵尸进程。
- **资源释放**：应用关闭时应该能够释放所有资源。

### 4. 长时间运行稳定性

- **长时间稳定**：应用应该能够稳定运行较长时间（数小时或数天）。
- **内存占用合理**：长时间运行后内存占用应保持在合理范围内。

## 日志中的关键指标

在日志中，以下指标特别重要：

1. **内存使用量变化**：查看"内存状态"行，关注进程内存和增长率。
2. **实例数量变化**：查看"实例清理"行，比较清理前后的实例数量。
3. **清理事件**：查看包含"清理"的行，确认定期清理是否执行。
4. **内存警告**：检查是否有内存使用率过高的警告。

## 实际使用测试

除了运行测试脚本，您还可以通过以下方式测试优化效果：

1. **长时间运行**：让应用持续运行24小时以上，监控内存使用情况。
2. **高负载测试**：添加大量（20+）直播间，观察系统稳定性。
3. **反复开关直播间**：反复添加和删除直播间，测试资源回收效果。
4. **应用重启测试**：多次启动和关闭应用，确保每次都能正确释放资源。

## 使用系统监控工具

您可以使用系统自带的监控工具来辅助验证：

- **Windows**: 任务管理器、资源监视器
- **macOS**: 活动监视器
- **Linux**: top、htop、free 命令

## 问题排查

如果发现内存问题仍然存在，请检查：

1. 日志中是否有异常或错误信息
2. 是否有未被正确清理的实例或进程
3. 是否有代码路径绕过了优化的清理机制

## 总结

通过以上测试和观察，您应该能够确认内存优化是否有效。有效的优化应该表现为：

- 内存使用稳定，不会持续增长
- 长时间运行后仍然保持响应迅速
- 实例和进程被正确清理
- 应用关闭时资源被完全释放 